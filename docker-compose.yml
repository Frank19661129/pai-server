version: '3.8'

services:
  claudine-server-v1:
    container_name: claudine-server-v1
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8002:8000"  # v1 development port (external:internal)
    environment:
      - DATABASE_URL=postgresql://claudine:claudine@host.docker.internal:5432/claudine_v1
      - DEBUG=true
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
    volumes:
      - ./app:/app/app  # Mount app directory for development hot-reload
    depends_on:
      - db-setup
    restart: unless-stopped
    networks:
      - claudine-network

  # Database setup service - runs once to create claudine_v1 database
  db-setup:
    image: postgres:15
    environment:
      - PGPASSWORD=claudine
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL...';
      until pg_isready -h host.docker.internal -U claudine; do
        sleep 1;
      done;
      echo 'PostgreSQL ready, checking/creating claudine_v1 database...';
      psql -h host.docker.internal -U claudine -tc \"SELECT 1 FROM pg_database WHERE datname = 'claudine_v1'\" | grep -q 1 ||
      psql -h host.docker.internal -U claudine -c 'CREATE DATABASE claudine_v1';
      echo 'Database claudine_v1 ready!';
      "
    networks:
      - claudine-network

networks:
  claudine-network:
    driver: bridge

# Notes:
# - Uses existing claudine-postgres container on host (port 5432)
# - Creates claudine_v1 database if it doesn't exist
# - Port 8002 for v1 development (v0 uses 8001)
# - Hot-reload enabled via volume mount for development
