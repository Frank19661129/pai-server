version: '3.8'

services:
  claudine-server-v1:
    container_name: claudine-server-v1
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8003:8000"  # v1 development port (external:internal) - using 8003 as 8002 is used by claudine-notes
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://claudine:claudine_dev_password@claudine-postgres:5432/claudine_v1
      - DEBUG=true
      - SECRET_KEY=${SECRET_KEY:-dev-secret-key-change-in-production}
    volumes:
      - ./app:/app/app  # Mount app directory for development hot-reload
    depends_on:
      - db-setup
    restart: unless-stopped
    networks:
      - server_claudine_network

  # Database setup service - runs once to create claudine_v1 database
  db-setup:
    image: postgres:15
    environment:
      - PGPASSWORD=claudine_dev_password
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for PostgreSQL...';
      until pg_isready -h claudine-postgres -U claudine; do
        sleep 1;
      done;
      echo 'PostgreSQL ready, checking/creating claudine_v1 database...';
      psql -h claudine-postgres -U claudine -tc \"SELECT 1 FROM pg_database WHERE datname = 'claudine_v1'\" | grep -q 1 ||
      psql -h claudine-postgres -U claudine -c 'CREATE DATABASE claudine_v1';
      echo 'Database claudine_v1 ready!';
      "
    networks:
      - server_claudine_network

networks:
  server_claudine_network:
    external: true

# Notes:
# - Uses existing claudine-postgres container on host (port 5432)
# - Creates claudine_v1 database if it doesn't exist
# - Port 8002 for v1 development (v0 uses 8001)
# - Hot-reload enabled via volume mount for development
